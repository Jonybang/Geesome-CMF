<h2>Mailing manager</h2>

<button class="btn btn-primary" ng-click="sendMail()">Send mail</button>

<br>
<uib-alert ng-if="alert" type="success" close="closeAlert()" dismiss-on-timeout="3000">{{alert}}</uib-alert>
<br>

<div class="row">
    <div class="col-md-8">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Mailing data</h3>
            </div>
            <div class="panel-body">
                <label>Subscribers groups:</label>
                <ae-select-input ng-model="mail.subscribers_groups_ids" has-error="hasErrors.subscribers_groups_ids" ng-resource="models.subscribers_groups" ng-resource-fields="fields.subscribers_groups" is-edit="true" adder="true" type="multiselect"></ae-select-input>

                <label>Mail template:</label>
                <ae-select-input ng-model="mail.mail_template_id" has-error="hasErrors.template_id" ng-resource="models.mail_templates" ng-resource-fields="fields.mail_templates" is-edit="true" adder="true"></ae-select-input>

                <div>
                    <a href ng-click="subTemplateEditShow = !subTemplateEditShow" ng-class="{'dropup': subTemplateEditShow}">
                        Edit current mail template <span class="caret"></span><br>
                    </a>
                    <div ng-if="subTemplateEditShow" class="alert alert-info">

                        <label>Mail template name:</label>
                        <ae-text-input ng-model="mail.mail_template.name" has-error="hasErrors.mail_template.name" is-edit="true"></ae-text-input>

                        <label>Mail template key:</label>
                        <ae-text-input ng-model="mail.mail_template.key" has-error="hasErrors.mail_template.key" is-edit="true"></ae-text-input>

                        <label>Mail title template:</label>
                        <ae-text-input ng-model="mail.mail_template.title" has-error="hasErrors.mail_template.title" is-edit="true"></ae-text-input>

                        <label>Mail content template:</label>
                        <wiz-markdown-editor content="mail.mail_template.content" textareaclass="form-control">
                            <wiz-toolbar-button command="bold">Bold</wiz-toolbar-button>
                            <wiz-toolbar-button command="italic">Italic</wiz-toolbar-button>
                            <wiz-toolbar-button command="undo">UNDO</wiz-toolbar-button>
                            <wiz-toolbar-button command="redo">REDO</wiz-toolbar-button>
                            <wiz-toolbar-button command="heading">HEADING</wiz-toolbar-button>
                            <wiz-toolbar-button command="code">CODE</wiz-toolbar-button>
                            <wiz-toolbar-button command="ullist">ULLIST</wiz-toolbar-button>
                            <wiz-toolbar-button command="ollist">OLLIST</wiz-toolbar-button>
                            <wiz-toolbar-button command="indent">INDENT</wiz-toolbar-button>
                            <wiz-toolbar-button command="outdent">OUTDENT</wiz-toolbar-button>
                            <wiz-toolbar-button command="link">LINK</wiz-toolbar-button>
                            <wiz-toolbar-button command="img">IMG</wiz-toolbar-button>
                            <wiz-toolbar-button command="hr">HR</wiz-toolbar-button>
                            <wiz-toolbar-button command="h0">H0</wiz-toolbar-button>
                            <wiz-toolbar-button command="h1">H1</wiz-toolbar-button>
                            <wiz-toolbar-button command="h2">H2</wiz-toolbar-button>
                            <wiz-toolbar-button command="h3">H3</wiz-toolbar-button>
                            <wiz-toolbar-button command="h4">H4</wiz-toolbar-button>
                            <wiz-toolbar-button command="h5">H5</wiz-toolbar-button>
                            <wiz-toolbar-button command="h6">H6</wiz-toolbar-button>
                        </wiz-markdown-editor>

                        <label>Available variables:</label>
                        <div>
                            <small ng-non-bindable>
                                In mail templates you may to use some all Settings variables, for example: <b>{{$site_url}}</b>, <b>{{$admin_email}}</b>;
                                <br>
                                also page variables(if page object is set to sended mail): <b>{{$title}}</b>, <b>{{$menu_title}}</b>, <b>{{$sub_title}}</b>, <b>{{$description}}</b>;
                                <br>
                                and additional sub variables: <b>{{$page_url}}</b>, <b>${{parent_title}}</b>, <b>${{parent_menu_title}}</b>, <b>${{parent_sub_title}}</b>, <b>${{parent_description}}</b>.
                            </small>
                        </div>

                    </div>
                </div>

                <label>Page object for use in template:</label>
                <ae-select-input ng-model="mail.page_id" name-field="title" has-error="hasErrors.page_id" ng-resource="models.pages" ng-resource-fields="fields.pages" is-edit="true" adder="true"></ae-select-input>
            </div>
            <div class="panel-footer">
                <label>Mail preview:</label>
                Title: {{mail.compiled_title}}<br>
                Content:
                <wiz-markdown content="mail.compiled_content"></wiz-markdown>
            </div>

        </div>
    </div>
    <div class="col-md-4">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Resend sended mail with new data</h3>
            </div>
            <div class="panel-body">
                <label>Sended mails:</label>

                <div class="list-group">
                    <a href
                       ng-repeat="sended_mail in sended_mails"
                       ui-sref="app.manage.mailing({sendedMailId: sended_mail.id})"
                       ng-class="['list-group-item', {'active':mail.id == sended_mail.id}]">
                        <h4 class="list-group-item-heading">{{sended_mails.result_title}}</h4>
                        <p class="list-group-item-text">{{sended_mails.result_content | limitTo: 50}}...</p>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<button class="btn btn-primary" ng-click="sendMail()">Send mail</button>