/* @preserve
 *
 * angular-bootstrap-file
 * https://github.com/itslenny/angular-bootstrap-file-field
 *
 * Version: 0.1.3 - 02/21/2015
 * License: MIT
 */

angular.module('bootstrap.fileField',[])
    .directive('fileField', function() {
        return {
            require:'ngModel',
            restrict: 'E',
            scope: {
                ngModel: '=',
                preview: '=',
                ngChange: '&'
            },
            link: function (scope, element, attrs, ngModel) {
                //set default bootstrap class
                if(!attrs.class && !attrs.ngClass){
                    element.addClass('btn');
                }

                var fileField = element.find('input');

                fileField.bind('change', function(event){
                    scope.$evalAsync(function () {
                        scope.ngModel = event.target.files;

                        if(attrs.preview){
                            scope.preview = [];
                            angular.forEach(event.target.files, function(file, index){
                                var reader = new FileReader();
                                reader.onload = function (e) {
                                    scope.$evalAsync(function(){
                                        scope.preview.splice(index, 0, e.target.result);

                                        if(scope.preview.length == event.target.files.length)
                                            scope.ngChange();
                                    });
                                };
                                reader.readAsDataURL(file);
                            });

                        }
                    });
                });
                fileField.bind('click',function(e){
                    e.stopPropagation();
                });
                element.bind('click',function(e){
                    e.preventDefault();
                    fileField[0].click()
                });
            },
            template:'<button type="button"><ng-transclude></ng-transclude><input type="file" multiple style="display:none"></button>',
            replace:true,
            transclude:true
        };
    });